(function () {
    'use strict';

    angular.module('reddmeetApp')
        .controller('ChatsController', ['$scope', '$mdDialog', '$mdMedia', '$rootScope', 'ChatFactory', ChatsController])
        .controller('MatchesController', ['$log', '$location', '$http', MatchesController])
        .controller('VisitsController', ['$log', '$http', VisitsController])
        .controller('DownvotesController', ['$log', '$http', DownvotesController])
        ;

    /**
     * Display most recent chat partners of auth user.
     */
    function ChatsController($scope, $mdDialog, $mdMedia, $rootScope, ChatFactory) {
        let vm = this;
        vm.isLoading = true;
        vm.title = "Recent messages";
        vm.chats = [];
        $scope.$on('chats:received', (event, data) => {
            vm.isLoading = false;
            vm.chats = ChatFactory.chats;
        });
        $rootScope.$broadcast('chat:viewedmsg', null);
        ChatFactory.requestChats();

        vm.openMessenger = function(username, event) {
            $mdDialog.show({
                controller: 'ChatDialogController',
                controllerAs: 'chat',
                templateUrl: 'views/chat.html',
                locals: { username: username },
                parent: angular.element(document.body),
                targetEvent: event,
                clickOutsideToClose: false,
                fullscreen: ($mdMedia('sm') || $mdMedia('xs')),
            });
        };
    }

    /**
     * Display three tabs with "upvotes received", "upvote matches", "upvotes sent".
     */
    function MatchesController($log, $location, $http) {
        var apiUrlTpl = API_BASE + '/api/v1/{}.json';
        var vm = this;
        vm.isLoading = true;
        vm.tabs = { selectedIndex: 1 };
        vm.title = "Upvotes and Matches";
        vm.userLists = { matches: [], upvotes_sent: [], upvotes_recv: [] };

        $location.search().recv && (vm.tabs.selectedIndex = 0);
        $location.search().matches && (vm.tabs.selectedIndex = 1);
        $location.search().sent && (vm.tabs.selectedIndex = 2);

        for (let x in vm.userLists) {
            $http.get(apiUrlTpl.replace('{}', x)).then(response => {
                vm.isLoading = false;
                vm.userLists[x] = response.data.user_list;
            }).catch(error => {
                vm.isLoading = false;
                $log.error('Error: ', error);
            });
        };
    }

    /**
     * Display two tabs with "viewed me" and "recently viewed".
     */
    function VisitsController($log, $http) {
        var apiUrlTpl = API_BASE + '/api/v1/{}.json';
        var vm = this;
        vm.isLoading = true;
        vm.tabs = { selectedIndex: 0 };
        vm.title = "Visits";
        vm.userLists = { visits: [], visitors: [] };

        for (let x in vm.userLists) {
            $http.get(apiUrlTpl.replace('{}', x)).then(response => {
                vm.isLoading = false;
                vm.userLists[x] = response.data.user_list;
            }).catch(error => {
                vm.isLoading = false;
                $log.error('Error: ', error);
            });
        };
    }

    /**
     * Display a list of users downvoted by authuser.
     */
    function DownvotesController($log, $http) {
        var apiUrlTpl = API_BASE + '/api/v1/{}.json';
        var vm = this;
        vm.isLoading = true;
        vm.tabs = { selectedIndex: 0 };
        vm.title = "Visits";
        vm.userLists = { downvoted: [] };

        for (let x in vm.userLists) {
            $http.get(apiUrlTpl.replace('{}', x)).then(response => {
                vm.isLoading = false;
                vm.userLists[x] = response.data.user_list;
            }).catch(error => {
                vm.isLoading = false;
                $log.error('Error: ', error);
            });
        };
    }

})();
